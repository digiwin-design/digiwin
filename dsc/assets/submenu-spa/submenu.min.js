'use strict';

(function () {
    // dev
    // let dir = '';
    // let path = '/tw/dsc/solution/mobile/WB002839/index#/merchandise'.split('/');
    // let hash = '';
    // final
    var dir = '/tw/dsc/assets/submenu-spa/';
    var path = location.href.split('/');
    var id = path.find(function (value) {
        return value.startsWith('WB');
    });
    var page = '#/' + path[path.length - 1].replace(/(.html|.htm)/g, '');
    var header = document.querySelector('.header-box header');

    if (header !== null) {
        new Vue({
            el: '#submenu',
            data: {
                results: [],
                currentPage: '',
                activeIndex: 0,
                isActive: false
            },
            methods: {
                // 取得選單內容
                getData: function getData() {
                    var _this = this;

                    fetch(''.concat(dir, 'submenu.json')).then(function (res) {
                        return res.json();
                    }).then(function (res) {
                        _this.results = res.filter(function (value) {
                            return value.id === id;
                        });

                        if (_this.results.length) {
                            _this.setActiveIndex();

                            _this.isActive = true;
                        }
                    });
                },
                // 設定目前頁面名稱(不含首頁)
                setCurrentPage: function setCurrentPage(text) {
                    if (text && !text.match(/首頁$/)) {
                        this.currentPage = text;
                    } else {
                        this.currentPage = '';
                    }
                },
                // 設定目前選單樣式
                setActiveIndex: function setActiveIndex() {
                    var _this2 = this;

                    this.results[0].menus.some(function (menu, index) {
                        if (menu.url === page) {
                            _this2.activeIndex = index;

                            _this2.setCurrentPage(menu.text);

                            return true;
                        } else if (menu.dropdowns) {
                            menu.dropdowns.forEach(function (dropdown) {
                                if (dropdown.url === page) {
                                    _this2.activeIndex = index;

                                    _this2.setCurrentPage(dropdown.text);
                                }
                            });
                        }
                    });
                },
                // 設定標題文字
                setTitle: function setTitle(value) {
                    return this.currentPage ? ''.concat(value, ' / ').concat(this.currentPage) : value;
                },
                // 判斷連結開啟方式
                linkTo: function linkTo(_ref) {
                    var url = _ref.url,
                        target = _ref.target,
                        anchor = _ref.anchor;

                    if (target) {
                        window.open(''.concat(url), target);
                    } else if (url && !anchor) {
                        window.open(''.concat(url), '_self');
                        this.setPageInfo(url);
                    } else if (!url && anchor) {
                        var targetPos = $(anchor).offset().top;
                        var offset = $('.page-submenu').outerHeight();
                        $('html, body').animate({
                            scrollTop: targetPos - offset
                        });
                    } else if (url && anchor) {
                        window.open(''.concat(url), '_self');
                        setTimeout(function () {
                            var targetPos = $(anchor).offset().top;
                            var offset = $('.page-submenu').outerHeight();
                            $('html, body').animate({
                                scrollTop: targetPos - offset
                            });
                        }, 100);
                        this.setPageInfo(url);
                    }
                },
                // 設定頁面資訊
                setPageInfo: function setPageInfo(url) {
                    page = url;
                    this.setActiveIndex();
                },
                openDropdown: function openDropdown(event) {
                    $(event.target).parents('li').addClass('is-open').siblings().removeClass('is-open');
                },
                closeDropdownHandler: function closeDropdownHandler(event) {
                    if ($(event.target).parents('.page-submenubox').length !== 1) {
                        $('.page-submenu-list > li').removeClass('is-open');
                    }
                }
            },
            created: function created() {
                header.insertAdjacentHTML('beforeend', '<div id="submenu"></div>');
                this.getData();
            },
            mounted: function mounted() {
                var _this3 = this;

                document.querySelector('body').addEventListener('touchstart', function (event) {
                    return _this3.closeDropdownHandler(event);
                });
            },
            beforeDestroy: function beforeDestroy() {
                document.querySelector('body').removeEventListener('touchstart');
            },
            template: '\n                <div class="page-submenubox" :class="{active:isActive}">\n                    <div class="page-submenu">\n                        <div class="container">\n                            <template v-for="result in results">\n                                <h2>{{setTitle(result.title)}}</h2>\n                                <ul class="page-submenu-list">\n                                    <li v-for="(menu, index) in result.menus">\n                                        <span :class="{active:index===activeIndex}">\n                                            <a :href="menu.url" @click.prevent="linkTo(menu)" @touchstart="openDropdown">{{menu.text}}</a>\n                                        </span>\n                                        <ul v-if="menu.dropdowns" class="page-submenu-dropdown">\n                                            <li v-for="dropdown in menu.dropdowns">\n                                                <a :href="dropdown.url" @click.prevent="linkTo(dropdown)">{{dropdown.text}}</a>\n                                            </li>\n                                        </ul>\n                                    </li>\n                                </ul>\n                            </template>\n                        </div>\n                    </div>\n                </div>\n            '
        });
    }
})();